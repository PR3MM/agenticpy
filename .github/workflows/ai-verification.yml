# This workflow demonstrates a proactive, sandboxed code verification process.
# It automatically triggers on pushes, generates code, verifies it in an isolated
# environment, and creates a pull request only if verification succeeds.
name: AI Code Generation and Verification

on:
  # The workflow will now trigger on every push to any branch.
  push:

jobs:
  verify-code:
    # The job will run on the latest version of Ubuntu provided by GitHub.
    runs-on: ubuntu-latest

    # This 'services' block sets up a Docker-in-Docker (DinD) environment.
    services:
      dind:
        image: docker:24-dind
        options: --privileged
        ports:
          - 2375:2375

    steps:
      # Step 1: Check out the repository code.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: This step simulates an AI generating or modifying code.
      - name: AI Generates Code
        id: ai-code-gen
        run: |
          mkdir -p app
          echo "def new_function(): return True" > app/generated_code.py
          echo "Generated app/generated_code.py"

      # Step 3: Build the verification container that will be used as a sandbox.
      - name: Build Verification Container
        run: |
          # The Dockerfile is now more explicit about what it copies.
          cat <<EOF > Dockerfile.verify
          FROM python:3.10-slim
          WORKDIR /sandbox
          RUN pip install z3-solver

          # Copy the verification script and the generated code into the container.
          COPY verify_code.py .
          COPY app/generated_code.py .

          # Set the default command to run our verification script.
          CMD ["python", "verify_code.py"]
          EOF

          # Build the Docker image from the root of the project.
          docker build -t verification-sandbox -f Dockerfile.verify .

      # Step 4: Run the verification logic inside the strictly isolated sandbox.
      - name: Run Verification in Isolated Sandbox
        run: |
          # The run command is now simpler as all files are inside the container.
          # No volume mounts are needed.
          docker run --rm \
            --network=none \
            --read-only \
            verification-sandbox

      # Step 5: If verification succeeds, create a pull request.
      - name: Create Pull Request on Success
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: AI-generated and verified code"
          title: "ðŸ¤– AI Verified: Add new function"
          body: |
            This code was generated by an AI and mathematically verified in a secure sandbox.
            - Verification passed successfully.
            - Ready for human review.
          branch: "ai-verified-code-${{ github.sha }}"
          delete-branch: true
